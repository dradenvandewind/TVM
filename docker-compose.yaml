version: '3.8'

services:
  build_tvm:
    build:
       context: .
       dockerfile: Dockerfile 
    
    shm_size: '1gb'
    image: tvm_beta
    container_name: tvm
    ipc: "host"
    privileged: true
    #networks:
    #  - net
    network_mode: "host"
    
    # Modern GPU support for Docker Compose 3.8+
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: -1
              capabilities: [gpu]
    
    restart: on-failure
    command: ["/bin/bash","-c","sleep 36000"]
    #entrypoint: ["/bin/sh", "/test_shaka.sh"]

    
    environment:
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
      - DISPLAY=:0
      - XAUTHORITY=/tmp/.docker.xauth
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/host/run/dbus/system_bus_socket
    
    volumes:
      - /sys:/sys
      - $HOME/.Xauthority:/root/.Xauthority
      - /run/dbus/system_bus_socket:/host/run/dbus/system_bus_socket
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth
      - /dev/shm:/dev/shm:rw

  tvm-worker:
    image: tvm_beta
    restart: on-failure
    ipc: "host"
    privileged: true
    network_mode: "host"
     
    # GPU support for worker service
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: -1
              capabilities: [gpu]
     
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=/tmp/.docker.xauth
      - XDG_RUNTIME_DIR=/tmp/runtime-root
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/host/run/dbus/system_bus_socket
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/tmp/.docker.xauth:ro
    
    shm_size: '1gb'
 
    healthcheck:
      test: ["CMD", "date", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 5
        
    depends_on:
      - build_tvm
    
    volumes:
      - /sys:/sys
      - $HOME/.Xauthority:/root/.Xauthority
      - /run/dbus/system_bus_socket:/host/run/dbus/system_bus_socket
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth
networks:
  net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    
  
